import requests
import json
import base64
import time

# í…ë°”ì´í… API URL
BASE_URL = "https://fapi.10x10.co.kr/api/web/v1/category/items/search"

# HTTP ìš”ì²­ í—¤ë” (ë´‡ íƒì§€ ë°©ì§€)
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
    "Referer": "https://www.10x10.co.kr/"
}

# Base64 ë””ì½”ë”© í•¨ìˆ˜
def decode_base64_url(encoded_url):
    try:
        # Base64 íŒ¨ë”© ìë™ ì¶”ê°€
        missing_padding = len(encoded_url) % 4
        if missing_padding:
            encoded_url += '=' * (4 - missing_padding)

        # URL-safe Base64 ë””ì½”ë”©
        decoded_bytes = base64.urlsafe_b64decode(encoded_url)
        return decoded_bytes.decode("utf-8")  # ë¬¸ìì—´ ë³€í™˜

    except Exception as e:
        print(f"ğŸš¨ ì´ë¯¸ì§€ URL ë””ì½”ë”© ì˜¤ë¥˜: {e}")
        return encoded_url  # ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ì›ë³¸ ê°’ ë°˜í™˜

# ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (API ìš”ì²­)
def get_product_list(page=1):
    params = {
        "catecode": "101107102",  # ìŠ¤í‹°ì»¤ ì¹´í…Œê³ ë¦¬ ì½”ë“œ
        "page": page,
        "sortMethod": "best"  # ì¸ê¸°ìˆœ ì •ë ¬
    }
    
    response = requests.get(BASE_URL, headers=HEADERS, params=params)
    
    if response.status_code == 200:
        data = response.json()
        return data  # ì „ì²´ JSON ì‘ë‹µ ë°˜í™˜
    else:
        print(f"ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨ (í˜ì´ì§€ {page}) - ìƒíƒœ ì½”ë“œ: {response.status_code}")
        return None

# ì „ì²´ í˜ì´ì§€ í¬ë¡¤ë§ (ëª¨ë“  ìƒí’ˆ ê°€ì ¸ì˜¤ê¸°)
def scrape_all_pages():
    all_products = []
    
    # ì²« í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì „ì²´ í˜ì´ì§€ ìˆ˜ í™•ì¸)
    first_page_data = get_product_list(page=1)
    if not first_page_data:
        print("âŒ ì²« í˜ì´ì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨")
        return []

    last_page = first_page_data["last_page"]  # ì „ì²´ í˜ì´ì§€ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    print(f"ğŸ“Œ ì´ {last_page} í˜ì´ì§€ í¬ë¡¤ë§ ì‹œì‘...")

    for page in range(1, last_page + 1):
        print(f"ğŸ“Œ {page} í˜ì´ì§€ í¬ë¡¤ë§ ì¤‘...")
        page_data = get_product_list(page)
        
        if not page_data or "items" not in page_data:
            print("âš ï¸ ë” ì´ìƒ ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŒ.")
            break

        products = page_data["items"]
        
        for product in products:
            product_info = {
                "name": product["item_name"],  # ìƒí’ˆëª…
                "price": product["item_price"],  # ê°€ê²©
                "product_id": str(product["item_id"]),  # ìƒí’ˆ ID (ë¬¸ìì—´ë¡œ ë³€í™˜)
                "category": product["category_name"],  # ì¹´í…Œê³ ë¦¬ëª…
                "image_url": decode_base64_url(product["list_image"]),  # ëª©ë¡ ì´ë¯¸ì§€ URL
                "high_res_image_url": decode_base64_url(product["big_image"]),  # ê³ í•´ìƒë„ ì´ë¯¸ì§€ URL
                "product_url": f"https://www.10x10.co.kr/shopping/category_list.asp?product_id={product['item_id']}",  # ìƒì„¸ í˜ì´ì§€ URL
                "brand": product.get("brand_name", "Unknown"),  # ë¸Œëœë“œëª…
                "review_rating": product.get("review_rating", 0),  # ë¦¬ë·° í‰ì 
                "review_count": product.get("review_cnt", 0),  # ë¦¬ë·° ê°œìˆ˜
                "wishlist_count": product.get("favcount", 0),  # ì°œ(ì¢‹ì•„ìš”) ê°œìˆ˜
                "discount_percent": product.get("sale_percent", 0),  # í• ì¸ìœ¨
                "is_ten_only": product.get("ten_only", False),  # í…ë°”ì´í… ë‹¨ë… ìƒí’ˆ ì—¬ë¶€
                "is_special_offer": product.get("specialOffer", False)  # íŠ¹ë³„í• ì¸ ì—¬ë¶€
            }
            all_products.append(product_info)

        time.sleep(1)  # ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ ëŒ€ê¸°

    return all_products

# ì‹¤í–‰
if __name__ == "__main__":
    print("ğŸ“Œ í…ë°”ì´í… ìŠ¤í‹°ì»¤ ìƒí’ˆ ì „ì²´ í¬ë¡¤ë§ ì‹œì‘...")
    products = scrape_all_pages()  # ëª¨ë“  í˜ì´ì§€ í¬ë¡¤ë§

    # JSON íŒŒì¼ ì €ì¥
    with open("tenbyten_all_products.json", "w", encoding="utf-8") as f:
        json.dump(products, f, ensure_ascii=False, indent=4)

    print(f"âœ… í¬ë¡¤ë§ ì™„ë£Œ! ì´ {len(products)}ê°œ ìƒí’ˆ ì €ì¥ë¨.")
    print("ğŸ“‚ ë°ì´í„° ì €ì¥ ì™„ë£Œ: tenbyten_all_products.json")


## JSON ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë³€í™˜ ##
import json
import pandas as pd

# JSON íŒŒì¼ ë¡œë“œ
json_file = "tenbyten_all_products.json"
csv_file = "tenbyten_all_products.csv"

with open(json_file, "r", encoding="utf-8") as f:
    products = json.load(f)

# DataFrame ë³€í™˜
df = pd.DataFrame(products)

# CSV ì €ì¥
df.to_csv(csv_file, index=False, encoding="utf-8-sig")

print(f"âœ… JSON ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë³€í™˜ ì™„ë£Œ! ğŸ“‚ {csv_file}")
